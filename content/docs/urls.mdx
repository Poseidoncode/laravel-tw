---
title: URL 產生
description: Laravel 提供輔助函式來為應用程式產生 URLs
---

# URL 產生 (URL Generation)

- [簡介](#introduction)
- [基礎](#the-basics)
    - [產生 URLs](#generating-urls)
    - [取得目前 URL](#accessing-the-current-url)
- [命名路由的 URLs](#urls-for-named-routes)
    - [簽名 URLs](#signed-urls)
- [Controller 動作的 URLs](#urls-for-controller-actions)
- [Fluent URI 物件](#fluent-uri-objects)
- [預設值](#default-values)

<a name="introduction"></a>
## 簡介

Laravel 提供了多個輔助函式來協助您為應用程式產生 URLs。這些輔助函式主要在您的樣板和 API 回應中建立連結時很有幫助，或是當您需要產生重新導向回應到應用程式的其他部分時也很實用。

<a name="the-basics"></a>
## 基礎

<a name="generating-urls"></a>
### 產生 URLs

`url` 輔助函式可用來為您的應用程式產生任意的 URLs。產生的 URL 將自動使用應用程式目前正在處理的請求的 scheme (HTTP 或 HTTPS) 和主機：

```php
$post = App\Models\Post::find(1);

echo url("/posts/{$post->id}");

// http://example.com/posts/1
```

要產生帶有查詢字串參數的 URL，您可以使用 `query` 方法：

```php
echo url()->query('/posts', ['search' => 'Laravel']);

// https://example.com/posts?search=Laravel

echo url()->query('/posts?sort=latest', ['search' => 'Laravel']);

// http://example.com/posts?sort=latest&search=Laravel
```

提供路徑中已經存在的查詢字串參數將會覆蓋它們現有的值：

```php
echo url()->query('/posts?sort=latest', ['sort' => 'oldest']);

// http://example.com/posts?sort=oldest
```

值的陣列也可以作為查詢參數傳遞。這些值將在產生的 URL 中被正確鍵入和編碼：

```php
echo $url = url()->query('/posts', ['columns' => ['title', 'body']]);

// http://example.com/posts?columns%5B0%5D=title&columns%5B1%5D=body

echo urldecode($url);

// http://example.com/posts?columns[0]=title&columns[1]=body
```

<a name="accessing-the-current-url"></a>
### 取得目前 URL

如果沒有提供路徑給 `url` 輔助函式，將會回傳一個 `Illuminate\Routing\UrlGenerator` 實例，讓您可以取得目前 URL 的資訊：

```php
// 取得不帶查詢字串的目前 URL...
echo url()->current();

// 取得包含查詢字串的目前 URL...
echo url()->full();
```

這些方法也可以透過 `URL` [Facade](/docs/facades) 來存取：

```php
use Illuminate\Support\Facades\URL;

echo URL::current();
```

<a name="accessing-the-previous-url"></a>
#### 取得前一個 URL

有時候知道使用者來自的前一個 URL 會很有幫助。您可以透過 `url` 輔助函式的 `previous` 和 `previousPath` 方法來取得前一個 URL：

```php
// 取得前一個請求的完整 URL...
echo url()->previous();

// 取得前一個請求的路徑...
echo url()->previousPath();
```

或者，透過 [session](/docs/session)，您可以取得前一個 URL 作為一個 [fluent URI](#fluent-uri-objects) 實例：

```php
use Illuminate\Http\Request;

Route::post('/users', function (Request $request) {
    $previousUri = $request->session()->previousUri();

    // ...
});
```

也可以透過 session 取得前一個訪問 URL 的路由名稱：

```php
$previousRoute = $request->session()->previousRoute();
```

<a name="urls-for-named-routes"></a>
## 命名路由的 URLs

`route` 輔助函式可用來產生指向[命名路由](/docs/routing#named-routes)的 URLs。命名路由讓您可以產生 URLs 而不必與路由上定義的實際 URL 耦合。因此，如果路由的 URL 變更，您不需要對 `route` 函式的呼叫進行任何修改。例如，假設您的應用程式包含如下定義的路由：

```php
Route::get('/post/{post}', function (Post $post) {
    // ...
})->name('post.show');
```

要產生指向此路由的 URL，您可以像這樣使用 `route` 輔助函式：

```php
echo route('post.show', ['post' => 1]);

// http://example.com/post/1
```

當然，`route` 輔助函式也可以用來產生具有多個參數的路由的 URLs：

```php
Route::get('/post/{post}/comment/{comment}', function (Post $post, Comment $comment) {
    // ...
})->name('comment.show');

echo route('comment.show', ['post' => 1, 'comment' => 3]);

// http://example.com/post/1/comment/3
```

任何不對應於路由定義參數的額外陣列元素將會被加入到 URL 的查詢字串：

```php
echo route('post.show', ['post' => 1, 'search' => 'rocket']);

// http://example.com/post/1?search=rocket
```

<a name="eloquent-models"></a>
#### Eloquent Models

您經常會使用 [Eloquent models](/docs/eloquent) 的路由鍵（通常是主鍵）來產生 URLs。因此，您可以將 Eloquent models 作為參數值傳遞。`route` 輔助函式將自動擷取模型的路由鍵：

```php
echo route('post.show', ['post' => $post]);
```

<a name="signed-urls"></a>
### 簽名 URLs

Laravel 讓您可以輕鬆建立指向命名路由的「簽名」URLs。這些 URLs 在查詢字串後附加了一個「簽名」雜湊，讓 Laravel 可以驗證 URL 自建立以來未被修改。簽名 URLs 對於可公開存取但需要一層防護來防止 URL 操縱的路由特別有用。

例如，您可能使用簽名 URLs 來實作一個公開的「取消訂閱」連結，透過電子郵件發送給您的客戶。要建立指向命名路由的簽名 URL，請使用 `URL` Facade 的 `signedRoute` 方法：

```php
use Illuminate\Support\Facades\URL;

return URL::signedRoute('unsubscribe', ['user' => 1]);
```

您可以透過向 `signedRoute` 方法提供 `absolute` 引數來從簽名 URL 雜湊中排除網域：

```php
return URL::signedRoute('unsubscribe', ['user' => 1], absolute: false);
```

如果您想產生一個在指定時間後過期的臨時簽名路由 URL，您可以使用 `temporarySignedRoute` 方法。當 Laravel 驗證臨時簽名路由 URL 時，它會確保編碼在簽名 URL 中的過期時間戳記尚未過期：

```php
use Illuminate\Support\Facades\URL;

return URL::temporarySignedRoute(
    'unsubscribe', now()->addMinutes(30), ['user' => 1]
);
```

<a name="validating-signed-route-requests"></a>
#### 驗證簽名路由請求

要驗證傳入請求是否具有有效簽名，您應該在傳入的 `Illuminate\Http\Request` 實例上呼叫 `hasValidSignature` 方法：

```php
use Illuminate\Http\Request;

Route::get('/unsubscribe/{user}', function (Request $request) {
    if (! $request->hasValidSignature()) {
        abort(401);
    }

    // ...
})->name('unsubscribe');
```

有時候，您可能需要讓應用程式的前端將資料附加到簽名 URL，例如在執行客戶端分頁時。因此，您可以使用 `hasValidSignatureWhileIgnoring` 方法指定在驗證簽名 URL 時應該忽略的請求查詢參數。請記住，忽略參數會讓任何人都可以修改請求上的這些參數：

```php
if (! $request->hasValidSignatureWhileIgnoring(['page', 'order'])) {
    abort(401);
}
```

您可以將 `signed`（`Illuminate\Routing\Middleware\ValidateSignature`）[middleware](/docs/middleware) 指派給路由，而不是使用傳入請求實例來驗證簽名 URLs。如果傳入請求沒有有效簽名，middleware 將自動回傳 `403` HTTP 回應：

```php
Route::post('/unsubscribe/{user}', function (Request $request) {
    // ...
})->name('unsubscribe')->middleware('signed');
```

如果您的簽名 URLs 在 URL 雜湊中不包含網域，您應該向 middleware 提供 `relative` 引數：

```php
Route::post('/unsubscribe/{user}', function (Request $request) {
    // ...
})->name('unsubscribe')->middleware('signed:relative');
```

<a name="responding-to-invalid-signed-routes"></a>
#### 回應無效的簽名路由

當有人訪問已過期的簽名 URL 時，他們會收到 `403` HTTP 狀態碼的通用錯誤頁面。但是，您可以透過在應用程式的 `bootstrap/app.php` 檔案中為 `InvalidSignatureException` 例外定義一個自訂「render」閉包來自訂此行為：

```php
use Illuminate\Routing\Exceptions\InvalidSignatureException;

->withExceptions(function (Exceptions $exceptions): void {
    $exceptions->render(function (InvalidSignatureException $e) {
        return response()->view('errors.link-expired', status: 403);
    });
})
```

<a name="urls-for-controller-actions"></a>
## Controller 動作的 URLs

`action` 函式為給定的 controller 動作產生 URL：

```php
use App\Http\Controllers\HomeController;

$url = action([HomeController::class, 'index']);
```

如果 controller 方法接受路由參數，您可以將路由參數的關聯陣列作為函式的第二個引數傳遞：

```php
$url = action([UserController::class, 'profile'], ['id' => 1]);
```

<a name="fluent-uri-objects"></a>
## Fluent URI 物件

Laravel 的 `Uri` 類別提供了一個便利且流暢的介面，用於透過物件建立和操作 URIs。這個類別封裝了底層 League URI 套件提供的功能，並與 Laravel 的路由系統無縫整合。

您可以使用靜態方法輕鬆建立 `Uri` 實例：

```php
use App\Http\Controllers\UserController;
use App\Http\Controllers\InvokableController;
use Illuminate\Support\Uri;

// 從給定的字串產生 URI 實例...
$uri = Uri::of('https://example.com/path');

// 產生指向路徑、命名路由或 controller 動作的 URI 實例...
$uri = Uri::to('/dashboard');
$uri = Uri::route('users.show', ['user' => 1]);
$uri = Uri::signedRoute('users.show', ['user' => 1]);
$uri = Uri::temporarySignedRoute('user.index', now()->addMinutes(5));
$uri = Uri::action([UserController::class, 'index']);
$uri = Uri::action(InvokableController::class);

// 從目前請求 URL 產生 URI 實例...
$uri = $request->uri();

// 從前一個請求 URL 產生 URI 實例...
$uri = $request->session()->previousUri();
```

一旦您有了 URI 實例，您可以流暢地修改它：

```php
$uri = Uri::of('https://example.com')
    ->withScheme('http')
    ->withHost('test.com')
    ->withPort(8000)
    ->withPath('/users')
    ->withQuery(['page' => 2])
    ->withFragment('section-1');
```

有關使用 fluent URI 物件的更多資訊，請參閱 [URI 文件](/docs/helpers#uri)。

<a name="default-values"></a>
## 預設值

對於某些應用程式，您可能希望為某些 URL 參數指定請求範圍的預設值。例如，假設您的許多路由都定義了 `{locale}` 參數：

```php
Route::get('/{locale}/posts', function () {
    // ...
})->name('post.index');
```

每次呼叫 `route` 輔助函式時都要傳遞 `locale` 是很繁瑣的。因此，您可以使用 `URL::defaults` 方法來定義此參數的預設值，該預設值將在目前請求期間始終套用。您可能希望從[路由 middleware](/docs/middleware#assigning-middleware-to-routes) 中呼叫此方法，以便您可以存取目前的請求：

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\URL;
use Symfony\Component\HttpFoundation\Response;

class SetDefaultLocaleForUrls
{
    /**
     * 處理傳入的請求。
     *
     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */
    public function handle(Request $request, Closure $next): Response
    {
        URL::defaults(['locale' => $request->user()->locale]);

        return $next($request);
    }
}
```

一旦設定了 `locale` 參數的預設值，您在透過 `route` 輔助函式產生 URLs 時就不再需要傳遞其值。

<a name="url-defaults-middleware-priority"></a>
#### URL 預設值和 Middleware 優先順序

設定 URL 預設值可能會干擾 Laravel 對隱式模型繫結的處理。因此，您應該[排序您的 middleware](/docs/middleware#sorting-middleware)，使設定 URL 預設值的 middleware 在 Laravel 自己的 `SubstituteBindings` middleware 之前執行。您可以在應用程式的 `bootstrap/app.php` 檔案中使用 `priority` middleware 方法來完成此操作：

```php
->withMiddleware(function (Middleware $middleware): void {
    $middleware->prependToPriorityList(
        before: \Illuminate\Routing\Middleware\SubstituteBindings::class,
        prepend: \App\Http\Middleware\SetDefaultLocaleForUrls::class,
    );
})
```
